// CABINE.AI v4 - Simplified Brand-Centric Schema
// AI Photo Studio for African Businesses

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════════

enum BusinessType {
  fashion
  food
  beauty
  realestate
  other
}

enum ShootStatus {
  draft
  in_progress
  completed
  archived
}

enum JobType {
  product_photo
  promo
  model
  caption
}

enum JobMode {
  preview    // 512px, 50 units
  final      // 1024px, 100 units
  final_4k   // 2048px, 200 units
}

enum JobStatus {
  queued
  processing
  completed
  failed
}

enum TransactionStatus {
  pending
  completed
  failed
}

enum PaymentMethod {
  wave
  orange_money
  visa
  free_trial
  bonus
}

// ═══════════════════════════════════════════════════════════════
// CREATOR ECOSYSTEM ENUMS
// ═══════════════════════════════════════════════════════════════

enum CreatorType {
  MODEL
  PHOTOGRAPHER
  LOCATION_OWNER
}

enum AssetType {
  MODEL_PROFILE
  PHOTO_STYLE
  LOCATION
}

enum AssetStatus {
  DRAFT           // Creator still editing
  PENDING_REVIEW  // Submitted for review
  APPROVED        // Live on marketplace
  REJECTED        // Failed review
  SUSPENDED       // Temporarily hidden
}

// ═══════════════════════════════════════════════════════════════
// NEW FEATURE ENUMS
// ═══════════════════════════════════════════════════════════════

enum BatchStatus {
  pending
  processing
  completed
  failed
  partial
}

enum CampaignStatus {
  draft
  active
  completed
  archived
}

enum VideoStatus {
  pending
  processing
  completed
  failed
}

// ═══════════════════════════════════════════════════════════════
// USER - The primary entity (owns brands, credits, etc.)
// ═══════════════════════════════════════════════════════════════

model User {
  id              String        @id @default(uuid())
  authId          String        @unique @map("auth_id") // Supabase Auth UUID
  email           String        @unique
  name            String?
  avatarUrl       String?       @map("avatar_url")

  // Credits & Plan (moved from Workspace)
  creditUnits     Int           @default(300) @map("credit_units") // 300 = 3 crédits gratuits
  plan            String        @default("free")
  businessType    BusinessType? @map("business_type")

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  brands          Brand[]
  shoots          Shoot[]       @relation("ShootCreator")
  creditLedger    CreditLedger[]
  transactions    Transaction[]
  exportJobs      ExportJob[]
  studioSessions  StudioSession[]

  // Creator ecosystem relations
  creatorProfile  CreatorProfile?
  assetUsages     AssetUsage[]
  creatorReviews  CreatorReview[]

  // New feature relations
  batchJobs       BatchJob[]
  campaigns       Campaign[]
  videoGenerations VideoGeneration[]

  @@map("users")
}

// ═══════════════════════════════════════════════════════════════
// BRAND - The business identity (visual + verbal DNA)
// ═══════════════════════════════════════════════════════════════

model Brand {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  name            String
  instagramHandle String?   @map("instagram_handle")
  isDefault       Boolean   @default(false) @map("is_default")

  // Full Brand DNA (visual + verbal)
  visualDNA       Json?     @map("visual_dna")
  // Structure: { colorPalette, typography, imageryStyle, composition }

  verbalDNA       Json?     @map("verbal_dna")
  // Structure: { tone, primary_language, emoji_palette, exemplars, cta_style, etc. }

  // Original analyzed data
  analyzedAt      DateTime? @map("analyzed_at")
  analysisSource  String?   @map("analysis_source") // "instagram", "manual", etc.

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products        Product[]

  // New feature relations
  instagramPosts  InstagramPost[]
  campaigns       Campaign[]
  performanceInsights Json?   @map("performance_insights") // Cached analytics

  @@index([userId])
  @@map("brands")
}

// ═══════════════════════════════════════════════════════════════
// CREDIT LEDGER (Audit Trail)
// ═══════════════════════════════════════════════════════════════

model CreditLedger {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  delta        Int      // +500 ou -100 (en unités)
  balanceAfter Int      @map("balance_after")
  reason       String   // purchase, generation, refund, bonus, quick_generate, multi_format
  refType      String?  @map("ref_type") // transaction, generation_job, export_job
  refId        String?  @map("ref_id")
  description  String?
  createdAt    DateTime @default(now()) @map("created_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("credit_ledger")
}

// ═══════════════════════════════════════════════════════════════
// PRODUCTS - Belong to a Brand
// ═══════════════════════════════════════════════════════════════

model Product {
  id           String   @id @default(uuid())
  brandId      String   @map("brand_id")
  name         String?
  originalUrl  String   @map("original_url")
  thumbnailUrl String   @map("thumbnail_url")
  nobgUrl      String?  @map("nobg_url")
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")

  brand           Brand           @relation(fields: [brandId], references: [id], onDelete: Cascade)
  jobs            GenerationJob[]
  studioSessions  StudioSession[]

  // New feature relations
  batchGenerations BatchGeneration[]

  @@index([brandId])
  @@map("products")
}

// ═══════════════════════════════════════════════════════════════
// TEMPLATES
// ═══════════════════════════════════════════════════════════════

model TemplatePack {
  id           String       @id @default(uuid())
  slug         String       @unique
  name         String
  vertical     BusinessType
  description  String?
  thumbnailUrl String?      @map("thumbnail_url")
  version      String       @default("1.0.0")
  isActive     Boolean      @default(true) @map("is_active")
  isDefault    Boolean      @default(false) @map("is_default")
  createdAt    DateTime     @default(now()) @map("created_at")

  templates    Template[]
  shoots       Shoot[]

  @@map("template_packs")
}

model Template {
  id             String   @id @default(uuid())
  packId         String   @map("pack_id")
  slug           String
  name           String
  type           JobType
  thumbnailUrl   String?  @map("thumbnail_url")
  prompt         String
  negativePrompt String?  @map("negative_prompt")
  systemPrompt   String?  @map("system_prompt")
  variables      Json     @default("{}")
  defaultParams  Json     @default("{}") @map("default_params")
  version        Int      @default(1)
  isActive       Boolean  @default(true) @map("is_active")
  sortOrder      Int      @default(0) @map("sort_order")
  createdAt      DateTime @default(now()) @map("created_at")

  pack           TemplatePack    @relation(fields: [packId], references: [id], onDelete: Cascade)
  jobs           GenerationJob[]

  @@unique([packId, slug])
  @@map("templates")
}

// ═══════════════════════════════════════════════════════════════
// SHOOTS & JOBS
// ═══════════════════════════════════════════════════════════════

model Shoot {
  id                 String      @id @default(uuid())
  userId             String      @map("user_id")
  templatePackId     String      @map("template_pack_id")
  name               String
  description        String?
  styleSeed          Int?        @map("style_seed")
  styleLock          Json?       @map("style_lock")
  fidelityPercent    Int         @default(70) @map("fidelity_percent") // 0-100
  defaultAspectRatio String      @default("1:1") @map("default_aspect_ratio")
  status             ShootStatus @default(draft)
  isQuickGenerate    Boolean     @default(false) @map("is_quick_generate")
  totalJobs          Int         @default(0) @map("total_jobs")
  completedJobs      Int         @default(0) @map("completed_jobs")
  creditsUsed        Int         @default(0) @map("credits_used") // En unités
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  user               User            @relation("ShootCreator", fields: [userId], references: [id], onDelete: Cascade)
  templatePack       TemplatePack    @relation(fields: [templatePackId], references: [id])
  jobs               GenerationJob[]
  exportJobs         ExportJob[]

  @@index([userId, status])
  @@map("shoots")
}

model GenerationJob {
  id             String    @id @default(uuid())
  idempotencyKey String    @unique @map("idempotency_key") // Anti-doublon
  shootId        String    @map("shoot_id")
  productId      String?   @map("product_id")
  templateId     String    @map("template_id")
  type           JobType
  mode           JobMode   @default(preview)
  status         JobStatus @default(queued)
  priority       Int       @default(5)
  inputParams    Json      @default("{}") @map("input_params")
  promptUsed     String?   @map("prompt_used")
  seedUsed       Int?      @map("seed_used")
  outputUrl      String?   @map("output_url")
  outputText     String?   @map("output_text")
  creditsCost    Int       @default(100) @map("credits_cost") // En unités
  retryCount     Int       @default(0) @map("retry_count")
  errorMessage   String?   @map("error_message")
  approved       Boolean?  // Pour swipe approve/reject
  queuedAt       DateTime  @default(now()) @map("queued_at")
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")

  shoot          Shoot     @relation(fields: [shootId], references: [id], onDelete: Cascade)
  product        Product?  @relation(fields: [productId], references: [id])
  template       Template  @relation(fields: [templateId], references: [id])

  @@index([shootId, status])
  @@index([status, priority])
  @@map("generation_jobs")
}

// ═══════════════════════════════════════════════════════════════
// EXPORT JOBS
// ═══════════════════════════════════════════════════════════════

model ExportJob {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  shootId      String?   @map("shoot_id")
  jobIds       String[]  @map("job_ids")
  format       String    @default("zip")
  status       JobStatus @default(queued)
  outputUrl    String?   @map("output_url")
  signedUrl    String?   @map("signed_url")
  signedUrlExp DateTime? @map("signed_url_exp")
  fileSize     Int?      @map("file_size")
  errorMessage String?   @map("error_message")
  createdAt    DateTime  @default(now()) @map("created_at")
  completedAt  DateTime? @map("completed_at")

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  shoot        Shoot?    @relation(fields: [shootId], references: [id])

  @@map("export_jobs")
}

// ═══════════════════════════════════════════════════════════════
// TRANSACTIONS
// ═══════════════════════════════════════════════════════════════

model Transaction {
  id               String            @id @default(uuid())
  userId           String            @map("user_id")
  amountFcfa       Int               @map("amount_fcfa")
  creditsPurchased Int               @map("credits_purchased") // En crédits affichés
  unitsToAdd       Int               @map("units_to_add")      // En unités (×100)
  paymentMethod    PaymentMethod     @map("payment_method")
  status           TransactionStatus @default(pending)
  externalRef      String?           @unique @map("external_ref")
  checkoutUrl      String?           @map("checkout_url")
  metadata         Json              @default("{}")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("transactions")
}

// ═══════════════════════════════════════════════════════════════
// STUDIO - Smart Generation Pipeline
// ═══════════════════════════════════════════════════════════════

enum BackgroundType {
  real_place    // Real Senegalese locations
  studio        // Professional studio backgrounds
  lifestyle     // Lifestyle/ambient scenes
  custom        // User uploaded backgrounds
}

enum PlacementType {
  table
  model
  floor
  shelf
  hanging
  custom
}

enum PresentationType {
  product_only  // Flat lay / packshot
  on_model      // Worn by model
  ghost         // Ghost mannequin
}

model Background {
  id           String         @id @default(uuid())
  slug         String         @unique
  name         String
  nameFr       String         @map("name_fr")
  type         BackgroundType
  category     String         // e.g., "beach", "urban", "interior", "market"
  imageUrl     String         @map("image_url")
  thumbnailUrl String         @map("thumbnail_url")

  // Metadata for harmonization
  lighting     String         // e.g., "natural_daylight", "golden_hour", "studio_soft"
  mood         String         // e.g., "warm", "professional", "vibrant", "luxe"
  colors       String[]       // Dominant colors for matching

  // Location info (for real places)
  location     String?        // e.g., "Dakar", "Saly", "Saint-Louis"
  landmark     String?        // e.g., "Sea Plaza", "Corniche", "Marché Sandaga"

  // Generation hints
  promptHints  String?        @map("prompt_hints")
  negativeHints String?       @map("negative_hints")

  // Pre-calculated lighting analysis from Gemini
  lightingData Json?          @map("lighting_data")
  // Structure: { direction: "right", temperature: "warm", intensity: "soft", shadows: "natural" }

  isActive     Boolean        @default(true) @map("is_active")
  isPremium    Boolean        @default(false) @map("is_premium")
  sortOrder    Int            @default(0) @map("sort_order")
  createdAt    DateTime       @default(now()) @map("created_at")

  studioSessions StudioSession[]

  @@index([type, isActive])
  @@map("backgrounds")
}

model StudioSession {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")

  // ═══════════════════════════════════════════════════════════════
  // WIZARD STATE - The Structured Brief
  // ═══════════════════════════════════════════════════════════════

  // Step 1: Products
  productId       String?   @map("product_id")
  productAnalysis Json?     @map("product_analysis")
  // Structure: { category, name, colors[], materials[], style, description }

  // Step 2: Presentation
  presentation    PresentationType?  @default(product_only)
  presentationDetails String?        @map("presentation_details")
  // e.g., "Senegalese woman model, waist-up shot"

  // Step 3: Scene
  backgroundId    String?   @map("background_id")
  sceneType       String?   @map("scene_type")  // "real_place", "ai_generated", "studio"

  // Step 4: Moodboard
  moodboardUrl    String?   @map("moodboard_url")
  styleInstruction String?  @map("style_instruction")
  // e.g., "Copy golden hour lighting, Vogue aesthetic"

  // ═══════════════════════════════════════════════════════════════
  // MODIFIERS - The "Chat Magic" (per-step notes)
  // ═══════════════════════════════════════════════════════════════
  modifiers       Json      @default("{}")
  // Structure: {
  //   "product_note": "Make it blue, zoom on buckle",
  //   "presentation_note": "Model smiling, casual pose",
  //   "scene_note": "Night time, rainy",
  //   "style_note": "Warm tones, editorial"
  // }

  // ═══════════════════════════════════════════════════════════════
  // CANVAS STATE - Product positioning on canvas
  // ═══════════════════════════════════════════════════════════════
  canvasState     Json?     @map("canvas_state")
  // Structure: { x, y, scale, rotation }

  // ═══════════════════════════════════════════════════════════════
  // WIZARD PROGRESS
  // ═══════════════════════════════════════════════════════════════
  currentStep     Int       @default(1) @map("current_step")  // 1-4
  completedSteps  Int[]     @default([]) @map("completed_steps")

  // ═══════════════════════════════════════════════════════════════
  // GENERATION OUTPUT
  // ═══════════════════════════════════════════════════════════════
  finalPrompt     String?   @map("final_prompt")
  generatedUrls   String[]  @default([]) @map("generated_urls")
  selectedUrl     String?   @map("selected_url")

  // Status & Meta
  status          String    @default("active") // active, generating, completed, abandoned
  creditsCost     Int       @default(0) @map("credits_cost")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  product         Product?    @relation(fields: [productId], references: [id])
  background      Background? @relation(fields: [backgroundId], references: [id])

  @@index([userId, status])
  @@map("studio_sessions")
}

// ═══════════════════════════════════════════════════════════════
// CREATOR ECOSYSTEM - Marketplace for Models, Photographers, Locations
// ═══════════════════════════════════════════════════════════════

model CreatorProfile {
  id              String       @id @default(uuid())
  userId          String       @unique @map("user_id")
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  type            CreatorType
  displayName     String       @map("display_name")
  bio             String?
  avatarUrl       String?      @map("avatar_url")

  // Verification (stored privately, never returned in public API)
  isVerified      Boolean      @default(false) @map("is_verified")
  verifiedAt      DateTime?    @map("verified_at")

  // Payout info (private - only used by payout job)
  payoutMethod    String?      @map("payout_method") // wave, orange_money
  payoutPhone     String?      @map("payout_phone")

  // Public stats only
  totalAssets     Int          @default(0) @map("total_assets")
  totalUsages     Int          @default(0) @map("total_usages")
  rating          Float?
  reviewCount     Int          @default(0) @map("review_count")

  // Social (optional)
  instagramHandle String?      @map("instagram_handle")

  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  assets          CreatorAsset[]
  payouts         CreatorPayout[]
  reviews         CreatorReview[]

  @@index([userId])
  @@index([type])
  @@index([isVerified])
  @@map("creator_profiles")
}

model CreatorAsset {
  id              String       @id @default(uuid())
  creatorId       String       @map("creator_id")
  creator         CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  type            AssetType
  status          AssetStatus  @default(DRAFT)

  // Public content
  title           String
  description     String?
  thumbnailUrl    String?      @map("thumbnail_url") // Public signed URL

  // Private content (signed URLs only for approved usage)
  imageUrls       String[]     @default([]) @map("image_urls") // Private bucket paths

  // MODEL_PROFILE specific
  modelGender     String?      @map("model_gender")
  modelAgeRange   String?      @map("model_age_range") // "18-25", "25-35", "35-45", "45+"
  modelStyles     String[]     @default([]) @map("model_styles") // ["casual", "professional", "traditional"]

  // Consent (REQUIRED for models - private bucket paths)
  consentFormPath   String?    @map("consent_form_path")
  idDocPath         String?    @map("id_doc_path")
  selfieVerifyPath  String?    @map("selfie_verify_path")
  consentVerified   Boolean    @default(false) @map("consent_verified")

  // PHOTO_STYLE specific
  stylePreset     Json?        @map("style_preset")

  // LOCATION specific
  locationName    String?      @map("location_name")
  locationCity    String?      @map("location_city")
  locationType    String?      @map("location_type")

  // Pricing (FIXED by platform - in credit units)
  priceUnits      Int          @default(50) @map("price_units") // 0.5 credits = 50 units

  // Categorization
  tags            String[]     @default([])

  // Stats
  usageCount      Int          @default(0) @map("usage_count")
  viewCount       Int          @default(0) @map("view_count")

  // Review audit
  reviewedAt      DateTime?    @map("reviewed_at")
  reviewedBy      String?      @map("reviewed_by") // Admin user ID
  rejectionReason String?      @map("rejection_reason")

  // Soft delete
  deletedAt       DateTime?    @map("deleted_at")

  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  usages          AssetUsage[]

  @@index([creatorId])
  @@index([type, status])
  @@index([status])
  @@index([deletedAt])
  @@map("creator_assets")
}

model AssetUsage {
  id                String       @id @default(uuid())

  assetId           String       @map("asset_id")
  asset             CreatorAsset @relation(fields: [assetId], references: [id])

  userId            String       @map("user_id")
  user              User         @relation(fields: [userId], references: [id])

  // Link to generation
  studioSessionId   String?      @map("studio_session_id")

  // Credits charged (from user's creditUnits)
  unitsCharged      Int          @map("units_charged") // Asset fee portion only

  // Payout tracking
  settledAt         DateTime?    @map("settled_at") // When included in a payout
  payoutId          String?      @map("payout_id")
  payout            CreatorPayout? @relation(fields: [payoutId], references: [id])

  createdAt         DateTime     @default(now()) @map("created_at")

  @@index([assetId])
  @@index([userId])
  @@index([settledAt])
  @@index([payoutId])
  @@map("asset_usages")
}

model CreatorPayout {
  id              String       @id @default(uuid())

  creatorId       String       @map("creator_id")
  creator         CreatorProfile @relation(fields: [creatorId], references: [id])

  // Amount
  amountFcfa      Int          @map("amount_fcfa") // Calculated from settled usages
  usageCount      Int          @map("usage_count") // Number of usages in this payout

  // Period
  periodStart     DateTime     @map("period_start")
  periodEnd       DateTime     @map("period_end")

  // Status: pending → processing → completed/failed
  status          String       @default("pending")

  // Payment details (set when processing)
  payoutMethod    String?      @map("payout_method")
  payoutPhone     String?      @map("payout_phone") // Snapshot at time of payout
  externalRef     String?      @map("external_ref") // Wave/OM transaction ID
  processedAt     DateTime?    @map("processed_at")
  failureReason   String?      @map("failure_reason")

  createdAt       DateTime     @default(now()) @map("created_at")

  usages          AssetUsage[]

  @@index([creatorId])
  @@index([status])
  @@index([createdAt])
  @@map("creator_payouts")
}

model CreatorReview {
  id              String       @id @default(uuid())

  creatorId       String       @map("creator_id")
  creator         CreatorProfile @relation(fields: [creatorId], references: [id])

  userId          String       @map("user_id")
  user            User         @relation(fields: [userId], references: [id])

  assetId         String?      @map("asset_id") // Optional - review specific asset

  rating          Int          // 1-5
  comment         String?

  createdAt       DateTime     @default(now()) @map("created_at")

  @@unique([userId, creatorId]) // One review per user per creator
  @@index([creatorId])
  @@map("creator_reviews")
}

// ═══════════════════════════════════════════════════════════════
// BATCH CATALOG GENERATION
// ═══════════════════════════════════════════════════════════════

model BatchJob {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")
  status          BatchStatus @default(pending)
  productIds      String[]    @map("product_ids")
  totalProducts   Int         @map("total_products")
  styleSettings   Json        @map("style_settings") // {presentation, scene, brandId}
  processedCount  Int         @default(0) @map("processed_count")
  successCount    Int         @default(0) @map("success_count")
  failedCount     Int         @default(0) @map("failed_count")
  estimatedCredits Int        @map("estimated_credits")
  usedCredits     Int         @default(0) @map("used_credits")
  createdAt       DateTime    @default(now()) @map("created_at")
  completedAt     DateTime?   @map("completed_at")

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  generations     BatchGeneration[]

  @@index([userId, status])
  @@map("batch_jobs")
}

model BatchGeneration {
  id          String    @id @default(uuid())
  batchJobId  String    @map("batch_job_id")
  productId   String    @map("product_id")
  status      JobStatus @default(queued)
  outputUrl   String?   @map("output_url")
  caption     String?
  errorMessage String?  @map("error_message")
  creditsCost Int       @default(100) @map("credits_cost")
  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")

  batchJob    BatchJob  @relation(fields: [batchJobId], references: [id], onDelete: Cascade)
  product     Product   @relation(fields: [productId], references: [id])

  @@index([batchJobId, status])
  @@map("batch_generations")
}

// ═══════════════════════════════════════════════════════════════
// CAMPAIGN MODE
// ═══════════════════════════════════════════════════════════════

model CampaignTemplate {
  id          String  @id @default(uuid())
  slug        String  @unique
  name        String
  nameFr      String  @map("name_fr")
  thumbnailUrl String? @map("thumbnail_url")
  styleLock   Json    @map("style_lock") // lighting, colorGrading, mood, visualTokens
  occasion    String? // "Tabaski", "Ramadan", etc.
  isPremium   Boolean @default(false) @map("is_premium")
  usageCount  Int     @default(0) @map("usage_count")
  createdAt   DateTime @default(now()) @map("created_at")

  campaigns   Campaign[]

  @@map("campaign_templates")
}

model Campaign {
  id            String         @id @default(uuid())
  userId        String         @map("user_id")
  brandId       String?        @map("brand_id")
  templateId    String?        @map("template_id")
  name          String
  targetCount   Int            @default(10) @map("target_count") // 5-20 images
  styleLock     Json           @map("style_lock")
  styleSeed     Int?           @map("style_seed") // For consistency
  status        CampaignStatus @default(draft)
  generatedCount Int           @default(0) @map("generated_count")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand         Brand?         @relation(fields: [brandId], references: [id])
  template      CampaignTemplate? @relation(fields: [templateId], references: [id])
  images        CampaignImage[]

  @@index([userId, status])
  @@map("campaigns")
}

model CampaignImage {
  id          String   @id @default(uuid())
  campaignId  String   @map("campaign_id")
  productId   String?  @map("product_id")
  outputUrl   String?  @map("output_url")
  approved    Boolean?
  sortOrder   Int      @default(0) @map("sort_order")
  caption     String?
  createdAt   DateTime @default(now()) @map("created_at")

  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@map("campaign_images")
}

// ═══════════════════════════════════════════════════════════════
// PERFORMANCE-LINKED DNA (Instagram Analytics)
// ═══════════════════════════════════════════════════════════════

model InstagramPost {
  id            String   @id @default(uuid())
  brandId       String   @map("brand_id")
  instagramId   String?  @map("instagram_id")
  imageUrl      String   @map("image_url")
  caption       String?

  // Engagement metrics
  likesCount    Int      @default(0) @map("likes_count")
  commentsCount Int      @default(0) @map("comments_count")
  viewsCount    Int      @default(0) @map("views_count")

  // Visual analysis
  visualTokens  String[] @default([]) @map("visual_tokens")
  lighting      String?
  framing       String?

  // Derived
  engagementScore Float? @map("engagement_score")
  postedAt      DateTime? @map("posted_at")
  scrapedAt     DateTime @default(now()) @map("scraped_at")

  brand         Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([brandId, instagramId])
  @@index([brandId, engagementScore])
  @@map("instagram_posts")
}

// ═══════════════════════════════════════════════════════════════
// VIDEO GENERATION (Kling AI)
// ═══════════════════════════════════════════════════════════════

model VideoGeneration {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")
  sourceImageUrl  String      @map("source_image_url")
  prompt          String?
  duration        Int         @default(5) // 5 or 10 seconds
  quality         String      @default("standard") // standard | pro
  externalTaskId  String?     @map("external_task_id") // Kling task ID
  status          VideoStatus @default(pending)
  outputUrl       String?     @map("output_url")
  creditsCost     Int         @default(0) @map("credits_cost")
  errorMessage    String?     @map("error_message")
  createdAt       DateTime    @default(now()) @map("created_at")
  completedAt     DateTime?   @map("completed_at")

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([externalTaskId])
  @@map("video_generations")
}
